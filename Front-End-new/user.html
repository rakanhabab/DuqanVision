<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>دكان فيجين - لوحة المستخدم</title>
  <meta name="description" content="لوحة تحكم المستخدم - دكان فيجين" />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin defer></script>
  <link rel="stylesheet" href="css/user.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script src="rag-system.js"></script>
</head>
<body>
  <!-- User Dashboard -->
  <div class="view active">
    <!-- Header -->
    <header class="header">
      <div class="wrap">
        <div class="brand">
          <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDYiIGhlaWdodD0iNDYiIHZpZXdCb3g9IjAgMCA0NiA0NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQ2IiBoZWlnaHQ9IjQ2IiByeD0iOCIgZmlsbD0idXJsKCNncmFkaWVudDApIi8+CjxkZWZzPgo8bGluZWFyR3JhZGllbnQgaWQ9ImdyYWRpZW50MCIgeDE9IjAiIHkxPSIwIiB4Mj0iNDYiIHkyPSI0NiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjZjk3MzE2Ii8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzhjNWNmNiIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPgo=" alt="Dukkan Vision">
          <span>دكان فيجين</span>
        </div>
        <div class="grow"></div>
        <div class="account">
          <div class="info">
            <div id="accName">مرحباً</div>
            <div id="accEmail">—</div>
            <button class="logout" onclick="logout()">تسجيل الخروج</button>
          </div>
        </div>
        <div class="account-btn-container">
          <button class="account-btn" onclick="toggleAccountMenu()">معلومات الحساب</button>
          
          <!-- Account Dropdown Menu -->
          <div class="account-dropdown" id="accountDropdown">
            <div class="dropdown-header">
              <div class="user-avatar">
                <div class="avatar-gradient"></div>
              </div>
              <div class="user-info">
                <div class="brand-name">دكان فيجين</div>
                <div class="user-name" id="dropdownName">ASSIEL O SARDIDI</div>
                <div class="user-email" id="dropdownEmail">assie55lsar@gmail.com</div>
              </div>
            </div>
            
            <div class="dropdown-content">
              <button class="dropdown-btn logout-btn" onclick="logout()">
                تسجيل الخروج
              </button>
              
              <div class="qr-section">
                <div class="qr-code" id="dropdownQR">
                  <!-- QR Code will be generated here -->
                </div>
                <div class="qr-label">QR Code</div>
              </div>
              
              <button class="dropdown-btn account-info-btn" onclick="showAccountInfo()">
                معلومات الحساب
              </button>
            </div>
          </div>
        </div>
        
        <!-- QR Code in Header -->
        <div class="barcode-container">
          <div class="barcode-small" id="smallBarcode" onclick="window.location.href='qr.html'" title="اضغط لعرض صفحة محاكاة مسح الباركود">
            <!-- QR Code Corners -->
            <div style="
              position: absolute;
              top: 8px;
              left: 8px;
              width: 16px;
              height: 16px;
              background: #000;
              border-radius: 3px;
            "></div>
            <div style="
              position: absolute;
              top: 8px;
              right: 8px;
              width: 16px;
              height: 16px;
              background: #000;
              border-radius: 3px;
            "></div>
            <div style="
              position: absolute;
              bottom: 8px;
              left: 8px;
              width: 16px;
              height: 16px;
              background: #000;
              border-radius: 3px;
            "></div>
            <!-- Center Logo -->
            <div style="
              position: absolute;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              width: 8px;
              height: 8px;
              background: #000;
              border-radius: 50%;
            "></div>
            <!-- Data Points -->
            <div style="
              position: absolute;
              top: 32px;
              left: 32px;
              width: 2px;
              height: 2px;
              background: #000;
              border-radius: 1px;
            "></div>
            <div style="
              position: absolute;
              top: 40px;
              left: 40px;
              width: 2px;
              height: 2px;
              background: #000;
              border-radius: 1px;
            "></div>
            <div style="
              position: absolute;
              top: 48px;
              left: 32px;
              width: 2px;
              height: 2px;
              background: #000;
              border-radius: 1px;
            "></div>
            <div style="
              position: absolute;
              top: 32px;
              left: 48px;
              width: 2px;
              height: 2px;
              background: #000;
              border-radius: 1px;
            "></div>
            <!-- Data Points -->
            <div style="
              position: absolute;
              bottom: 5px;
              left: 50%;
              transform: translateX(-50%);
              background: rgba(255,255,255,0.9);
              color: #000;
              padding: 2px 4px;
              border-radius: 3px;
              font-size: 8px;
              font-weight: bold;
              white-space: nowrap;
            ">QR Code</div>
          </div>
          <div style="
            position: absolute;
            top: -30px;
            right: 0;
            background: #333;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
          " id="barcodeTooltip">اضغط لعرض صفحة محاكاة مسح الباركود</div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main">
      <div class="wrap">
        <!-- Dashboard Content -->
        <div id="page-dashboard" class="page active">
          <div class="dashboard-grid">
            <!-- Left Column -->
            <div class="left-column">
              <!-- Data Summary Cards -->
              <div class="data-summary">
                <div class="summary-cards">
                  <div class="summary-card yellow">
                    <div class="card-content">
                      <div class="card-title">إجمالي المصروف</div>
                      <div class="card-value" id="kSpend">1560.34 ر.س</div>
                      <canvas id="sparkSpend" width="100" height="30"></canvas>
                    </div>
                  </div>
                  <div class="summary-card green">
                    <div class="card-content">
                      <div class="card-title">عدد الزيارات</div>
                      <div class="card-value" id="kVisits">102</div>
                      <canvas id="sparkVisits" width="100" height="30"></canvas>
                    </div>
                  </div>
                  <div class="summary-card yellow">
                    <div class="card-content">
                      <div class="card-title">أكثر فرع زيارة</div>
                      <div class="card-value" id="kTop">Twq Pick - الرياض</div>
                      <canvas id="sparkTop" width="100" height="30"></canvas>
                    </div>
                  </div>
                  <div class="summary-card green">
                    <div class="card-content">
                      <div class="card-title">متوسط الفاتورة</div>
                      <div class="card-value" id="kAvg">65.14 ر.س</div>
                      <canvas id="sparkAvg" width="100" height="30"></canvas>
                    </div>
                  </div>
                </div>
                <button class="btn btn-purple" onclick="updateData()">تحديث البيانات</button>
              </div>

              <!-- Map Section -->
              <div class="map-section">
                <div class="card">
                  <h3>خريطة الفروع - السعودية</h3>
                  <div id="map" style="height: 400px; width: 100%; border-radius: 8px;"></div>
                </div>
              </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
              <!-- Virtual Assistant -->
              <div class="assistant-section">
                <div class="card">
                  <h3>المساعد الافتراضي</h3>
                  <div class="assistant-greeting">مرحباً .. كيف أقدر أخدمك؟</div>
                  <div class="chat-input">
                    <div class="chat-input-container">
                      <textarea placeholder="اسأل عن منتج، فاتورة، فروع، طريقة التسوق..." id="chatInput" rows="4"></textarea>
                      <button class="send-btn" onclick="sendMessage()">إرسال</button>
                    </div>
                    <div class="chat-messages" id="chatMessages"></div>
                  </div>
                </div>
              </div>

              <!-- Invoices Section -->
              <div class="invoices-section">
                <div class="card">
                  <h3>الفواتير</h3>
                  <div class="invoices-list" id="invoicesList">
                    <div class="invoice-item">
                      <div class="invoice-info">
                        <div class="invoice-id">#1028</div>
                        <div class="invoice-date">2025-08-03</div>
                      </div>
                      <div class="invoice-amount">31.40 ر.س</div>
                      <button class="btn btn-purple btn-sm">استعراض</button>
                    </div>
                    <div class="invoice-item">
                      <div class="invoice-info">
                        <div class="invoice-id">#1019</div>
                        <div class="invoice-date">2025-07-22</div>
                      </div>
                      <div class="invoice-amount">15.90 ر.س</div>
                      <button class="btn btn-purple btn-sm">استعراض</button>
                    </div>
                    <div class="invoice-item">
                      <div class="invoice-info">
                        <div class="invoice-id">#1007</div>
                        <div class="invoice-date">2025-07-03</div>
                      </div>
                      <div class="invoice-amount">31.50 ر.س</div>
                      <button class="btn btn-purple btn-sm">استعراض</button>
                    </div>
                  </div>
                  <div class="invoices-link">
                    <a href="#" onclick="showSubpage('invoices')">إدارة فواتيري -</a>
                  </div>
                </div>
              </div>

              <!-- Product Search -->
              <div class="search-section">
                <div class="card">
                  <h3>ابحث عن توافر المنتجات</h3>
                  <div class="search-input">
                    <input type="text" placeholder="مثال: حليب قليل الدسم" id="productSearch">
                    <button class="btn btn-gradient" onclick="searchProducts()">بحث</button>
                  </div>
                </div>
              </div>

              <!-- Contact Form -->
              <div class="contact-section">
                <div class="card">
                  <h3>تواصل معنا</h3>
                  <form id="contactForm">
                    <input type="text" placeholder="اسمك" id="contactName" required>
                    <input type="tel" placeholder="رقم الجوال" id="contactPhone" required>
                    <textarea placeholder="رسالتك" id="contactMessage" rows="4" required></textarea>
                    <button type="submit" class="btn btn-gradient">ارسال</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

        
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="wrap">
        <div class="footer-content">
          <div class="footer-copyright">
            2025 - جميع الحقوق محفوظة.
          </div>
          <div class="footer-brand">
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDYiIGhlaWdodD0iNDYiIHZpZXdCb3g9IjAgMCA0NiA0NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQ2IiBoZWlnaHQ9IjQ2IiByeD0iOCIgZmlsbD0idXJsKCNncmFkaWVudDApIi8+CjxkZWZzPgo8bGluZWFyR3JhZGllbnQgaWQ9ImdyYWRpZW50MCIgeDE9IjAiIHkxPSIwIiB4Mj0iNDYiIHkyPSI0NiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjZjk3MzE2Ii8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzhjNWNmNiIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPgo=" alt="Dukkan Vision">
            <span>دكان فيجين</span>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <!-- Scripts -->
  <script src="js/user.js"></script>
  
  <script>
    // Initialize RAG system with Supabase data
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        await initializeRAGSystem();
        console.log('RAG system ready');
        
        // Load user invoices
        await loadUserInvoices();
      } catch (error) {
        console.error('Failed to initialize RAG system:', error);
      }
    });

    // Chat functionality with RAG system
    async function sendMessage() {
      const chatInput = document.getElementById('chatInput');
      const chatMessages = document.getElementById('chatMessages');
      const message = chatInput.value.trim();
      
      if (!message) return;
      
      // Add user message
      addMessage(message, 'user');
      chatInput.value = '';
      
      // Show loading message
      const loadingId = addMessage('جاري البحث عن إجابة...', 'loading');
      
      try {
        // Get response from RAG system
        const response = await tuwaiqRAG.answerQuestion(message);
        
        // Remove loading message and add assistant response
        removeMessage(loadingId);
        addMessage(response, 'assistant');
      } catch (error) {
        console.error('Error getting response:', error);
        removeMessage(loadingId);
        addMessage('عذراً، حدث خطأ في الاتصال. يرجى المحاولة مرة أخرى.', 'assistant');
      }
    }
    
    function addMessage(text, type) {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      const messageId = 'msg_' + Date.now();
      
      messageDiv.id = messageId;
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      return messageId;
    }
    
    function removeMessage(messageId) {
      const message = document.getElementById(messageId);
      if (message) {
        message.remove();
      }
    }
    
    // Allow Enter key to send message
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Search products function
    async function searchProducts() {
      const searchInput = document.getElementById('productSearch');
      const query = searchInput.value.trim();
      
      if (!query) {
        alert('يرجى إدخال اسم المنتج للبحث');
        return;
      }

      try {
        // Get first branch for inventory search
        const branches = await supabaseService.getBranches();
        if (branches.length === 0) {
          alert('لا توجد فروع متاحة');
          return;
        }

        const products = await supabaseService.searchProductsWithInventory(query, branches[0].id);
        
        if (products.length > 0) {
          const productList = products.map(item => 
            `${item.products.name} - ${item.products.price} ر.س - الكمية المتوفرة: ${item.quantity}`
          ).join('\n');
          
          alert(`المنتجات الموجودة في ${branches[0].name}:\n${productList}`);
        } else {
          alert('لم يتم العثور على منتجات تطابق البحث');
        }
      } catch (error) {
        console.error('Error searching products:', error);
        alert('حدث خطأ في البحث');
      }
    }

    // Load user invoices
    async function loadUserInvoices() {
      try {
        const currentUser = JSON.parse(localStorage.getItem('twq_current'));
        if (!currentUser) {
          console.log('No current user found, using demo data');
          // Show demo invoices if no user logged in
          const demoInvoices = [
            {
              id: 'demo-1',
              timestamp: new Date().toISOString(),
              total_amount: 31.40,
              status: 'paid',
              branches: { name: 'فرع العليا' }
            },
            {
              id: 'demo-2', 
              timestamp: new Date(Date.now() - 86400000).toISOString(),
              total_amount: 15.90,
              status: 'paid',
              branches: { name: 'فرع النرجس' }
            }
          ];
          updateInvoicesDisplay(demoInvoices);
          return;
        }

        const invoices = await supabaseService.getUserInvoices(currentUser.id);
        updateInvoicesDisplay(invoices);
      } catch (error) {
        console.error('Error loading invoices:', error);
        // Show demo data on error
        const demoInvoices = [
          {
            id: 'demo-1',
            timestamp: new Date().toISOString(),
            total_amount: 31.40,
            status: 'paid',
            branches: { name: 'فرع العليا' }
          }
        ];
        updateInvoicesDisplay(demoInvoices);
      }
    }

    // Update invoices display
    function updateInvoicesDisplay(invoices) {
      const invoicesList = document.getElementById('invoicesList');
      if (!invoicesList) return;

      invoicesList.innerHTML = '';
      
      invoices.forEach(invoice => {
        const invoiceItem = document.createElement('div');
        invoiceItem.className = 'invoice-item';
        invoiceItem.innerHTML = `
          <div class="invoice-info">
            <div class="invoice-id">#${invoice.id.slice(0, 8)}</div>
            <div class="invoice-date">${new Date(invoice.timestamp).toLocaleDateString('ar-SA')}</div>
            <div class="invoice-branch">${invoice.branches?.name || 'غير محدد'}</div>
          </div>
          <div class="invoice-amount">${invoice.total_amount} ر.س</div>
          <button class="btn btn-purple btn-sm" onclick="viewInvoice('${invoice.id}')">استعراض</button>
        `;
        invoicesList.appendChild(invoiceItem);
      });
    }

    // View invoice details
    async function viewInvoice(invoiceId) {
      try {
        const invoice = await supabaseService.getInvoiceById(invoiceId);
        if (invoice) {
          const products = JSON.parse(invoice.products_and_quantities || '[]');
          const productList = products.map(p => `${p.name} x${p.quantity}`).join('\n');
          
          alert(`تفاصيل الفاتورة #${invoiceId.slice(0, 8)}:\n\nالفرع: ${invoice.branches?.name}\nالتاريخ: ${new Date(invoice.timestamp).toLocaleDateString('ar-SA')}\nالحالة: ${invoice.status}\n\nالمنتجات:\n${productList}\n\nالمجموع: ${invoice.total_amount} ر.س`);
        }
      } catch (error) {
        console.error('Error viewing invoice:', error);
        alert('حدث خطأ في عرض الفاتورة');
      }
    }
  </script>
  </script>
</body>
</html> 