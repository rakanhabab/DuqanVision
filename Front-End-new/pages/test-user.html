<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>اختبار صفحة المستخدم - دكان فيجين</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/user.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .test-title {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 15px;
        }
        .test-button {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
        }
        .success { color: #059669; }
        .error { color: #dc2626; }
        .info { color: #2563eb; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 style="text-align: center; color: #111827; margin-bottom: 30px;">
            🧪 اختبار صفحة المستخدم - دكان فيجين
        </h1>

        <!-- اختبار قاعدة البيانات -->
        <div class="test-section">
            <div class="test-title">🗄️ اختبار قاعدة البيانات</div>
            <button class="test-button" onclick="testDatabaseConnection()">اختبار الاتصال</button>
            <button class="test-button" onclick="testUserData()">اختبار بيانات المستخدم</button>
            <button class="test-button" onclick="testInvoices()">اختبار الفواتير</button>
            <div id="db-result" class="test-result"></div>
        </div>

        <!-- اختبار المساعد الذكي -->
        <div class="test-section">
            <div class="test-title">🤖 اختبار المساعد الذكي</div>
            <button class="test-button" onclick="testRAGConnection()">اختبار RAG API</button>
            <button class="test-button" onclick="testChat()">اختبار المحادثة</button>
            <div id="rag-result" class="test-result"></div>
        </div>

        <!-- اختبار الواجهة -->
        <div class="test-section">
            <div class="test-title">🎨 اختبار الواجهة</div>
            <button class="test-button" onclick="testNotifications()">اختبار الإشعارات</button>
            <button class="test-button" onclick="testAnimations()">اختبار الانيميشن</button>
            <button class="test-button" onclick="testResponsive()">اختبار التجاوب</button>
            <div id="ui-result" class="test-result"></div>
        </div>

        <!-- اختبار الأمان -->
        <div class="test-section">
            <div class="test-title">🔒 اختبار الأمان</div>
            <button class="test-button" onclick="testAuthentication()">اختبار المصادقة</button>
            <button class="test-button" onclick="testLogout()">اختبار تسجيل الخروج</button>
            <div id="security-result" class="test-result"></div>
        </div>

        <!-- النتائج الإجمالية -->
        <div class="test-section">
            <div class="test-title">📊 النتائج الإجمالية</div>
            <button class="test-button" onclick="runAllTests()">تشغيل جميع الاختبارات</button>
            <div id="overall-result" class="test-result"></div>
        </div>
    </div>

    <script type="module">
        import { db } from '../js/database.js';

        // اختبار قاعدة البيانات
        window.testDatabaseConnection = async function() {
            const result = document.getElementById('db-result');
            result.innerHTML = '<span class="info">جاري اختبار الاتصال...</span>';
            
            try {
                const { data, error } = await db.supabase.from('users').select('count').limit(1);
                if (error) throw error;
                result.innerHTML = '<span class="success">✅ الاتصال بقاعدة البيانات ناجح</span>';
            } catch (error) {
                result.innerHTML = `<span class="error">❌ فشل الاتصال: ${error.message}</span>`;
            }
        };

        // اختبار بيانات المستخدم
        window.testUserData = async function() {
            const result = document.getElementById('db-result');
            result.innerHTML = '<span class="info">جاري اختبار بيانات المستخدم...</span>';
            
            try {
                const currentUser = JSON.parse(localStorage.getItem('current_user') || 'null');
                if (!currentUser) {
                    result.innerHTML = '<span class="error">❌ لا يوجد مستخدم مسجل دخول</span>';
                    return;
                }
                
                const { data, error } = await db.supabase
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (error) throw error;
                result.innerHTML = `<span class="success">✅ بيانات المستخدم محملة: ${data.first_name} ${data.last_name}</span>`;
            } catch (error) {
                result.innerHTML = `<span class="error">❌ فشل في تحميل بيانات المستخدم: ${error.message}</span>`;
            }
        };

        // اختبار الفواتير
        window.testInvoices = async function() {
            const result = document.getElementById('db-result');
            result.innerHTML = '<span class="info">جاري اختبار الفواتير...</span>';
            
            try {
                const currentUser = JSON.parse(localStorage.getItem('current_user') || 'null');
                if (!currentUser) {
                    result.innerHTML = '<span class="error">❌ لا يوجد مستخدم مسجل دخول</span>';
                    return;
                }
                
                const { data, error } = await db.supabase
                    .from('invoices')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .limit(5);
                
                if (error) throw error;
                result.innerHTML = `<span class="success">✅ تم تحميل ${data.length} فاتورة</span>`;
            } catch (error) {
                result.innerHTML = `<span class="error">❌ فشل في تحميل الفواتير: ${error.message}</span>`;
            }
        };

        // اختبار RAG API
        window.testRAGConnection = async function() {
            const result = document.getElementById('rag-result');
            result.innerHTML = '<span class="info">جاري اختبار RAG API...</span>';
            
            try {
                const response = await fetch('http://localhost:8001/', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    result.innerHTML = '<span class="success">✅ RAG API يعمل بشكل صحيح</span>';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                result.innerHTML = `<span class="error">❌ RAG API غير متاح: ${error.message}</span>`;
            }
        };

        // اختبار المحادثة
        window.testChat = async function() {
            const result = document.getElementById('rag-result');
            result.innerHTML = '<span class="info">جاري اختبار المحادثة...</span>';
            
            try {
                const response = await fetch('http://localhost:8001/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        question: 'مرحبا',
                        user_id: 'test-user',
                        user_name: 'مستخدم اختبار'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    result.innerHTML = '<span class="success">✅ المحادثة تعمل بشكل صحيح</span>';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                result.innerHTML = `<span class="error">❌ فشل في المحادثة: ${error.message}</span>`;
            }
        };

        // اختبار الإشعارات
        window.testNotifications = function() {
            const result = document.getElementById('ui-result');
            result.innerHTML = '<span class="info">جاري اختبار الإشعارات...</span>';
            
            // إنشاء إشعار نجاح
            const notification = document.createElement('div');
            notification.textContent = 'اختبار الإشعارات';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
                font-weight: 600;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
                result.innerHTML = '<span class="success">✅ الإشعارات تعمل بشكل صحيح</span>';
            }, 2000);
        };

        // اختبار الانيميشن
        window.testAnimations = function() {
            const result = document.getElementById('ui-result');
            result.innerHTML = '<span class="info">جاري اختبار الانيميشن...</span>';
            
            const testElement = document.createElement('div');
            testElement.textContent = 'عنصر اختبار';
            testElement.style.cssText = `
                padding: 20px;
                background: #8b5cf6;
                color: white;
                border-radius: 8px;
                margin: 10px 0;
                animation: fadeInUp 0.5s ease-out;
            `;
            
            document.querySelector('.test-container').appendChild(testElement);
            
            setTimeout(() => {
                testElement.remove();
                result.innerHTML = '<span class="success">✅ الانيميشن يعمل بشكل صحيح</span>';
            }, 1000);
        };

        // اختبار التجاوب
        window.testResponsive = function() {
            const result = document.getElementById('ui-result');
            const width = window.innerWidth;
            
            if (width < 768) {
                result.innerHTML = '<span class="success">✅ التجاوب للموبايل يعمل</span>';
            } else if (width < 1024) {
                result.innerHTML = '<span class="success">✅ التجاوب للتابلت يعمل</span>';
            } else {
                result.innerHTML = '<span class="success">✅ التجاوب للديسكتوب يعمل</span>';
            }
        };

        // اختبار المصادقة
        window.testAuthentication = function() {
            const result = document.getElementById('security-result');
            const currentUser = localStorage.getItem('current_user');
            
            if (currentUser) {
                result.innerHTML = '<span class="success">✅ المستخدم مسجل دخول</span>';
            } else {
                result.innerHTML = '<span class="error">❌ لا يوجد مستخدم مسجل دخول</span>';
            }
        };

        // اختبار تسجيل الخروج
        window.testLogout = function() {
            const result = document.getElementById('security-result');
            result.innerHTML = '<span class="info">جاري اختبار تسجيل الخروج...</span>';
            
            // محاكاة تسجيل الخروج
            localStorage.removeItem('current_user');
            
            setTimeout(() => {
                const currentUser = localStorage.getItem('current_user');
                if (!currentUser) {
                    result.innerHTML = '<span class="success">✅ تسجيل الخروج يعمل بشكل صحيح</span>';
                } else {
                    result.innerHTML = '<span class="error">❌ فشل في تسجيل الخروج</span>';
                }
            }, 500);
        };

        // تشغيل جميع الاختبارات
        window.runAllTests = async function() {
            const result = document.getElementById('overall-result');
            result.innerHTML = '<span class="info">جاري تشغيل جميع الاختبارات...</span>';
            
            let passed = 0;
            let total = 0;
            
            // اختبار قاعدة البيانات
            total++;
            try {
                const { data, error } = await db.supabase.from('users').select('count').limit(1);
                if (!error) passed++;
            } catch (e) {}
            
            // اختبار RAG API
            total++;
            try {
                const response = await fetch('http://localhost:8001/', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    mode: 'cors'
                });
                if (response.ok) passed++;
            } catch (e) {}
            
            // اختبار المصادقة
            total++;
            if (localStorage.getItem('current_user')) passed++;
            
            const percentage = Math.round((passed / total) * 100);
            result.innerHTML = `<span class="${percentage >= 80 ? 'success' : 'error'}">
                📊 النتائج: ${passed}/${total} (${percentage}%)
            </span>`;
        };

        // إضافة CSS للانيميشن
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { opacity: 0; transform: translateX(30px); }
                to { opacity: 1; transform: translateX(0); }
            }
            @keyframes fadeInUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
